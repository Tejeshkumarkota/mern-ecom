(window.dullscriptWebpackJsonp=window.dullscriptWebpackJsonp||[]).push([[38],{1399:function(A,F,b){function a(H){var S=T.call(this)||this;S.$=H;S.dc();return S}function c(H){switch(H){case 1:return"Edit";case 2:return"View";case 3:return"InstantView";default:return"Unknown"}}function e(H){switch(H){case 3:return"Word";case 2:return"PowerPoint";case 1:return"Excel";default:return"Unknown"}}function l(H,S,K,da,fa,X){var ca=this;da=void 0===da?!1:da;fa=void 0===fa?null:fa;X=void 0===X?null:X;this.zDa=
this.yDa=0;this.Oyb=this.jSb=!1;this.Uqa=null;this.vWa=!0;this.JVb=null;t.ULS.sendTraceTag(26019598,378,100,"Initializing SafeLinksManager.");this.wb=H;this.Tg=S;this.YPb=K;l.Ah=X;this.Ryg=da?this.wb.Ua("SafeLinksHandlerWebServiceBase"):this.wb.Ua("WebServiceBase");this.Byg=this.wb.Ua("SafeLinksHashedUserId");this.XYj=this.wb.Ua("SafeLinksWorkloadIdHeaderValue");this.DTb=this.wb.Ad("SafeLinksMaxGetPolicyBootRetries",2);this.ETb=this.wb.Ad("SafeLinksMaxGetPolicyOnLinkClickRetries",1);this.NSb=this.isSafeLinksEnabledForUser();
this.MSb=this.Wmi();t.ULS.sendTraceTag(26019599,378,50,"SafeLinksManager _isEnabledForUser={0}, _isEnabledForBrowser={1}",this.NSb,this.MSb);if(this.NSb&&this.MSb){S=(H=this.t3a())?H.IsSafeLinksEnabled.toLowerCase():"";K=this.Rpd();t.ULS.sendTraceTag(36231312,378,50,"Cached values for IsSafeLinksEnabled: {0}, IsPolicyCookieExpired: {1}.",S,K);var ja=!H||"unknown"===S||H.WasServiceDown||K,ea=J.a.Wr();ea&&(ea.set("shouldGetSafeLinksDataFromServer",ja.toString()),ea.set("isSafeLinksEnabledCacheValue",
S.toString()));this.wb.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksLicenseCheck",!1)&&fa?(this.vWa=!1,fa.execute(function(qa){qa.isFeatureEnabled("MsoUrlreputation",!0).then(function(pa){ca.vWa=pa;ea.set("isUserLicensedForSafeLinks",ca.vWa.toString());r.Health.instance.recordKpiUsage("SafeLinksGetPolicy1",0,"jpittsdirects",ea);ca.vWa&&ja&&ca.Obc(!0);return null})})):(r.Health.instance.recordKpiUsage("SafeLinksGetPolicy1",0,"jpittsdirects",ea),ja&&this.Obc(!0))}}function n(H,S,K,
da){this.wb=H;this.Tg=S;this.Ipg=K;n.Ah=da}function m(H,S){this.szc=H;this.stopwatch=S}function f(H,S,K,da,fa,X){this.PolicyCookie=this.WebAffinitizedUrl=this.IsSafeLinksEnabled=null;this.PolicyCookieTTL=0;this.WasServiceDown=!1;this.AffinitizedUrl=null;this.IsSafeLinksEnabled=H;this.WebAffinitizedUrl=S;this.PolicyCookie=K;this.PolicyCookieTTL=da;this.WasServiceDown=fa;this.AffinitizedUrl=X}b.r(F);var x=b(10);A=b(0);var y=b(5);F=b(214);var t=b(13),B=b(80);Object(A.a)(f,"SafeLinksData",null,[]);Object(A.a)(m,
"SafeLinksGetUrlReputationRequestData",null,[]);var z=b(40),u=b(47);n.prototype.xBa=function(H,S,K){try{var da=null;n.Ah&&(da=n.Ah.Hc("WebServiceCall","SafeLinksGetUrlReputation"));var fa=new m(S,da);da={};da.AffinitizedUrl=H;da.TargetUrl=S;da.PolicyCookie=K;var X=z.c(da);this.Tg.Xl(this.Ipg,2,X,null,!1,2,Object(B.a)(this,this.BNi,"onGetUrlReputationSuccessCallback"),Object(B.a)(this,this.ANi,"onGetUrlReputationFailureCallback"),fa,void 0,void 0,3E3,3E3,"36");return!0}catch(ca){t.ULS.sendTraceTag(588788033,
378,10,ca.message)}return!1};n.prototype.BNi=function(H){var S="OnGetUrlReputationSuccessCallback: ",K=10,da=H.data.state;try{var fa=z.b(H.data.ie).reputationResults[0],X=fa.navigateUrl.length,ca=da.szc.length,ja=fa.navigateUrl===da.szc;fa.navigateUrl&&0<fa.navigateUrl.length&&(da.szc=fa.navigateUrl);S+=String.format("HttpStatus {0}, verdict {1}, clickedUrlLength = {2} navigateUrlLength {3}, navigateUrlSameAsClickedUrl {4}",H.data.httpStatus,fa.verdict,ca.toString(),X.toString(),ja.toString());K=
50}catch(ea){S+=String.format("Exception {0}",ea.message)}this.U6e(da,S,K)};n.prototype.ANi=function(H){var S="OnGetUrlReputationFailureCallback: ",K=H.data.state;try{S+=String.format("HttpStatus {0}",H.data.httpStatus)}catch(da){S+=String.format("Exception {0}",da.message)}this.U6e(K,S,10)};n.prototype.U6e=function(H,S,K){H.stopwatch&&(H.stopwatch.stop(),H.stopwatch=null);t.ULS.sendTraceTag(588788034,378,K,S);u.a.vf(H.szc,void 0,"noopener,noreferrer","SafeLinksNav")};n.Ah=null;Object(A.a)(n,"SafeLinksNavigationHelper",
null,[]);var C;(function(H){H[H.enabledByPolicy=0]="enabledByPolicy";H[H.disabledByPolicy=1]="disabledByPolicy";H[H.disabled_GetPolicyFailure=2]="disabled_GetPolicyFailure";H[H.disabled_PendingGetPolicyRequest=3]="disabled_PendingGetPolicyRequest"})(C||(C={}));Object(A.b)("SafeLinksNavigationState",C);var r=b(95),J=b(129),v=b(951),D=b(277),V=b(231),U=b(807),Q=b(23),la=b(178),ba=b(338);l.prototype.xBa=function(H){if(!H)return t.ULS.sendTraceTag(593367827,378,10,"SafeLinksManager.TryNavigate: Null/Empty targetUrl"),
!1;var S=this.Fji(H);t.ULS.sendTraceTag(594830615,378,50,"SafeLinksManager.TryNavigate: isSupportedHyperLinkType={0},_isEnabledForUser={1},_isEnabledForBrowser={2},_isUserLicensedForSafeLinks={3}",S,this.NSb,this.MSb,this.vWa);if(!(S&&this.NSb&&this.MSb&&this.vWa))return!1;var K=this.Wzj();S=K.state;K=K.returnValue;t.ULS.sendTraceTag(595079385,378,50,"ShouldTryUsingSafeLinksService returned NavigationState={0}",C[S]);var da=J.a.Wr();da&&da.set("SafeLinksNavigationState",C[S]);r.Health.instance.recordKpiUsage("SafeLinksNavigations",
0,"jpittsdirects",da);if(!K)return 2!==S&&3!==S||r.Health.instance.recordKpiFailure("SafeLinksNavigations",C[S],!1,!0,null),!1;t.ULS.sendTraceTag(26019601,378,50,"Using safelinks to navigate hyperlink");if(this.cAj())return this.Rpd()?!1:this.sDi.xBa(this.OJh(),H,this.o2e());if(!this.Rpd())return this.gbg(H),!0;this.Uqa=H;t.ULS.sendTraceTag(24462627,378,50,"Refreshing the cache as policy cookie expired.");this.Oyb=!1;this.Obc();return!0};l.prototype.Fji=function(H){H=H.toLowerCase();var S=this.wb.fw("SafeLinksUnsupportedProtocols");
if(S)for(var K=0;K<S.length;K++)if(H.startsWith(S[K]))return!1;return!0};l.prototype.Obc=function(H){H=void 0===H?!1:H;var S=J.a.Wr();S&&S.set("isOnBootRequest",H.toString());r.Health.instance.recordKpiUsage("SafeLinksGetPolicySuccessfulRequest",1,"jpittsdirects",S);r.Health.instance.recordKpiUsage("SafeLinksGetPolicyFailedRequest",0,"jpittsdirects",S);S=this.v3c("SafeLinksGetPolicy");this.Tg.Xl(this.VVh,1,null,null,!0,2,Object(B.a)(this,this.iYh,"getSafeLinksDataFromServer_OnSuccessCallback"),Object(B.a)(this,
this.hYh,"getSafeLinksDataFromServer_OnFailureCallback"),S,void 0,void 0,void 0,void 0,"23");this.Oyb=H;this.jSb=!0;H?this.yDa++:this.zDa++};l.prototype.iYh=function(H){var S=V.a.sEi,K="";try{this.jSb=this.Oyb=!1;var da=this.Dyc(H.data.state).returnValue,fa=Object.assign(new ba.a,{durationMs:da});r.Health.instance.recordKpiSuccess("SafeLinksGetPolicySuccessfulRequest",fa);t.ULS.sendTraceTag(594830614,378,50,"GetSafeLinksDataFromServer_OnSuccessCallback: HttpStatus {0}, data length {1}, Duration {2}",
H.data.httpStatus,H.data.ie.length,da);if(H.data.httpStatus!==V.a.kP)K="Unexpected httpStatus: "+H.data.httpStatus.toString();else{da=null;try{da=z.b(H.data.ie)}catch(Xa){K="Exception:"+Xa.toString()+" deserializing response";return}if(da){var X=da.IsSafeLinksEnabled;if(void 0===X||null===X||0>=X.length)K="Invalid isSafeLinksEnabledString";else{t.ULS.sendTraceTag(594830613,378,50,"Retrieved isSafeLinksEnabledString {0}",X);var ca=l.bDd(X);if(void 0===da.WebAffinitizedUrl||null===da.WebAffinitizedUrl||
0>=da.WebAffinitizedUrl.length)K="Invalid WebAffinitizedUrl";else if(void 0===da.PolicyCookie||null===da.PolicyCookie||0>=da.PolicyCookie.length)K="Invalid PolicyCookie";else if(void 0===da.PolicyCookieTTL||null===da.PolicyCookieTTL)K="Invalid PolicyCookieTTL";else{var ja=da.WebAffinitizedUrl,ea=da.PolicyCookie,qa=da.AffinitizedUrl,pa=new Date;pa.setMinutes(pa.getMinutes()+(5<da.PolicyCookieTTL?da.PolicyCookieTTL-5:0));var Pa=pa.getTime(),Ha=new f(X,ja,ea,Pa,!1,qa);this.cZf(Ha);S=H.data.httpStatus;
this.Uqa&&(ca?(this.gbg(this.Uqa),this.zDa=this.yDa=0):(t.ULS.sendTraceTag(26019602,378,50,"SafeLinks is disabled by admin; Navigating without SafeLinks"),r.Health.instance.recordKpiFailure("SafeLinksNavigations","disabledByPolicy",!0,!0,null),u.a.fV(this.Uqa)),this.Uqa=null)}}}else K="Error when serializing response into SafeLinksData. SafeLinksData is null."}}catch(Xa){K="GetSafeLinksDataFromServer_OnSuccessCallback: Exception:  "+Xa.toString()}finally{S!==V.a.kP&&this.T6e(S,K)}};l.prototype.hYh=
function(H){this.jSb=!1;var S=500,K="";try{var da=this.Dyc(H.data.state).returnValue,fa=Object.assign(new ba.a,{durationMs:da});S=H.data.httpStatus;r.Health.instance.recordKpiFailure("SafeLinksGetPolicyFailedRequest","HttpStatusCode_"+S.toString(),!1,!0,fa);K="Request Failed, Status="+U.a[H.data.status]+" Duration: "+da}catch(X){K="GetSafeLinksDataFromServer_OnFailureCallback Exception: "+X.toString()}finally{this.T6e(S,K)}};l.prototype.T6e=function(H,S){S=void 0===S?"":S;try{if(t.ULS.sendTraceTag(594830612,
378,10,"HandleGetPolicyRequestError: HttpStatus {0}, Error {1}",H,S),this.yDa<this.DTb&&this.zDa<this.ETb)this.Obc(this.Oyb);else{this.Oyb=!1;t.ULS.sendTraceTag(24462656,378,10,"Exhausted all retries for SafeLinks GetPolicy call. OnBootRetries: {0}, OnClickRetries: {1}, HttpStatus: {2}, Error: {3}",this.yDa,this.zDa,H,S);S=null;var K=J.a.Wr();K&&(K.set("HttpStatus",H.toString()),S=Object.assign(new ba.a,{extendedProperties:K}));r.Health.instance.recordKpiFailure("SafeLinksGetPolicy1","GetPolicyRequestError",
!1,!0,S);var da=new f("false","","",0,!0,"");this.cZf(da);this.Uqa&&(t.ULS.sendTraceTag(26019603,378,50,"Error occurred during at-click GetPolicy call, NavigationState = {0}","disabled_GetPolicyFailure"),r.Health.instance.recordKpiFailure("SafeLinksNavigations","disabled_GetPolicyFailure",!1,!0,null),u.a.fV(this.Uqa),this.Uqa=null)}}catch(fa){t.ULS.sendTraceTag(594830611,378,10,"HandleGetPolicyRequestError: Exception {0}",fa.toString())}};l.prototype.gbg=function(H){var S=this.o2e(),K=this.p1h(),
da={};da.Url=H;da.SafeLinksCookie=S;da.CorrelationId=la.a.create().toString();da.WorkloadId=this.XYj;da.UserAgentInfo=Q.a.yGa+"|"+this.appName;t.ULS.sendTraceTag(23900187,378,50,"Validating hyperlink with request correlation: {0}",da.CorrelationId);u.a.Zpc(u.a.CX(4),K,da)};l.prototype.isSafeLinksEnabledForUser=function(){var H=this.wb.Ua("IsSafeLinksEnabledForUser");return H?l.bDd(H):!1};l.prototype.Wmi=function(){var H=this.wb.fw("SafeLinksDisabledBrowsers");if(Q.a.MC){if(this.wb.Ty("SafeLinksForTeamsIsEnabled")&&
this.wb.ra("SafeLinksForTeamsIsEnabled"))return!0;if(Array.contains(H,"Electron"))return!1}else if(Array.contains(H,Q.a.yGa))return!1;return"officecomhwa"===(this.wb.Ua(y.AFrameworkApplication.Aea)||"").toLowerCase()?!1:!0};l.prototype.cAj=function(){return-1!==window.location.href.indexOf("&wd_slnh=1")?!0:Q.a.MC};l.prototype.Wzj=function(){var H=0;var S=this.t3a(),K=S?S.IsSafeLinksEnabled:"";if(""!==K)return S.WasServiceDown?(t.ULS.sendTraceTag(51663971,378,50,"Failed to retrieve policy data"),{returnValue:!1,
state:2}):"false"===K.toLowerCase()?(t.ULS.sendTraceTag(51664E3,378,50,"SafeLinks disabled for the user"),{returnValue:!1,state:1}):{returnValue:l.bDd(K),state:H};if(this.jSb)return H=3,t.ULS.sendTraceTag(595079384,378,50,"Currently getting SafeLinks policy"),{returnValue:!1,state:H};if(this.yDa>=this.DTb||this.zDa>=this.ETb)return H=2,t.ULS.sendTraceTag(51664001,378,50,"Exhausted all retries- Failure in GetPolicy for SafeLinks ({0}/{1} boot, {2}/{3} onClick)",this.yDa,this.DTb,this.zDa,this.ETb),
{returnValue:!1,state:H};t.ULS.sendTraceTag(23900182,378,10,"Inconsistent SafeLinks state: SafeLinks cache data is null with no on boot request pending, and {0} retries left over. Perhaps LocalStorage is inaccessable.",this.DTb+this.ETb-(this.yDa+this.zDa));return{returnValue:!0,state:H}};l.prototype.o2e=function(){var H=this.t3a();return H?H.PolicyCookie:""};l.prototype.p1h=function(){var H=this.t3a();return H?H.WebAffinitizedUrl:""};l.prototype.OJh=function(){var H=this.t3a();return H?H.AffinitizedUrl:
""};l.prototype.LPh=function(){var H=new Date;try{var S=this.t3a();H.setTime(S?S.PolicyCookieTTL:0)}catch(K){t.ULS.sendTraceTag(24462658,378,10,"Exception occured while fetching expiration time from cache: {0}",K)}return H};l.prototype.Rpd=function(){var H=this.LPh();return!!H&&H.getTime()<Date.now()};l.prototype.t3a=function(){if(!this.JVb){var H=v.a.instance.getItem(this.userId);if(!H||""===H)return null;this.JVb=JSON.parse(H)}return this.JVb};l.prototype.cZf=function(H){if(void 0===H||null===H)throw Error.argumentNull("safeLinksData");
if(void 0===H.IsSafeLinksEnabled||null===H.IsSafeLinksEnabled||0>=H.IsSafeLinksEnabled.length)throw Error.argumentNull("safeLinksData.IsSafeLinksEnabled");this.JVb=H;H.WasServiceDown||this.eZj(H)};l.prototype.eZj=function(H){H=JSON.stringify(H);v.a.instance.setItem(this.userId,H)};l.prototype.v3c=function(H){return void 0!==l.Ah&&null!==l.Ah?l.Ah.Hc("WebServiceCall",H):null};l.prototype.Dyc=function(H){if(void 0!==H&&null!==H){var S=H.Dc;H.stop();return{returnValue:S,stopwatch:null}}return{returnValue:null,
stopwatch:H}};l.bDd=function(H){return"false"!==H.toLowerCase()?!0:!1};Sk.Object.defineProperties(l.prototype,{appName:{configurable:!0,enumerable:!0,get:function(){return this.YPb}},QCc:{configurable:!0,enumerable:!0,get:function(){return this.Ryg}},userId:{configurable:!0,enumerable:!0,get:function(){return this.Byg}},VVh:{configurable:!0,enumerable:!0,get:function(){var H=this.QCc?this.QCc+"/":"",S=new D.QueryStringBuilder("SafeLinksHandler.ashx");S.Hi("app",this.appName);this.wb.ra("SafeLinksUseDebugHeader")&&
S.Hi("action","debug");this.wb.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksS2SAuthAATPOP",!1)&&S.Hi("s2satpop","1");this.wb.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksS2SAuthAAT",!1)&&S.Hi("s2saat","1");this.wb.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksS2SAuthUseE03App",!1)&&S.Hi("s2se03","1");return String.format("{0}{1}&{2}",H,S.toString(),y.AFrameworkApplication.mj)}},D0h:{configurable:!0,enumerable:!0,get:function(){var H=this.QCc?this.QCc+
"/":"",S=new D.QueryStringBuilder("SafeLinksHandler.ashx");S.Hi("app",this.appName);this.wb.ra("SafeLinksUseDebugHeader")&&S.Hi("action","debug");this.wb.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksS2SAuthAATPOP",!1)&&S.Hi("s2satpop","1");this.wb.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksS2SAuthAAT",!1)&&S.Hi("s2saat","1");this.wb.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksS2SAuthUseE03App",!1)&&S.Hi("s2se03","1");S.Hi("slrt","GetUrlReputation");
return String.format("{0}{1}&{2}",H,S.toString(),y.AFrameworkApplication.mj)}},sDi:{configurable:!0,enumerable:!0,get:function(){l.fQc||(l.fQc=new n(this.wb,this.Tg,this.D0h,l.Ah));return l.fQc}}});l.Ah=null;l.fQc=null;Object(A.a)(l,"SafeLinksManager",null,[397]);var T=F.a;vm(a,T);a.prototype.create=function(){this.Fb(this.$.da.Aa(269)||new l(y.AFrameworkApplication.ga,y.AFrameworkApplication.Jd,String.format("{0}-{1}",e(y.AFrameworkApplication.sa.Qa.Pj),c(y.AFrameworkApplication.sa.Qa.nca))))};a.ja=
function(H){H.da.Ha(270,new a(H))};Object(A.a)(a,"SafeLinksManagerFactory",F.a,[]);Type.registerNamespace("_Ewa");Type.registerNamespace("Common.App.SafeLinks");(function(){x.a.Ga(function(H){a.ja(H)})})()}}]);

//# sourceMappingURL=https://artifacts.dev.azure.com/office/_apis/symbol/symsrv/EwaDS.safelinks.js.map/95bc6843128dbfab36333b7fe8849e24/EwaDS.safelinks.js.map